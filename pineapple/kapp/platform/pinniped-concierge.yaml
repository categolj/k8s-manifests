apiVersion: kappctrl.k14s.io/v1alpha1
kind: App
metadata:
  name: pinniped-concierge
  namespace: kapp
  annotations:
    kapp.k14s.io/change-group: "{name}"
    kapp.k14s.io/change-rule.create-order.0: "upsert after upserting pinniped-supervisor"
    kapp.k14s.io/change-rule.delete-order.0: "delete before deleting pinniped-supervisor"
spec:
  serviceAccountName: kapp
  fetch:
  - http:
      url: https://github.com/vmware-tanzu/pinniped/releases/download/v0.15.0/install-pinniped-concierge-crds.yaml
  - http:
      url: https://github.com/vmware-tanzu/pinniped/releases/download/v0.15.0/install-pinniped-concierge-resources.yaml
  syncPeriod: 6h
  template:
  - ytt:
      ignoreUnknownComments: true
      paths:
      - .
      inline:
        paths:
          jwtauthenticator.yaml: |
            apiVersion: authentication.concierge.pinniped.dev/v1alpha1
            kind: JWTAuthenticator
            metadata:
               name: supervisor-jwt-authenticator
               namespace: pinniped-concierge
            spec:
               issuer: https://supervisor.pineapple.maki.lol
               audience: pineapple
               claims:
                 username: username
                 groups: groups
          fix-ip.yaml: |
            #@ load("@ytt:overlay", "overlay")
            #@overlay/match by=overlay.subset({"kind": "CredentialIssuer", "metadata": {"name": "pinniped-concierge-config"}})
            ---
            spec:
              impersonationProxy:
                service:
                  #@overlay/match missing_ok=True
                  loadBalancerIP: 192.168.11.230
          fix-diff.yaml: |
            #@ load("@ytt:overlay", "overlay")
            #@overlay/match by=overlay.subset({"kind": "CustomResourceDefinition"}), expects="1+"
            ---
            #! https://github.com/vmware-tanzu/carvel-kapp/issues/395
            #@overlay/remove
            status:
          kapp-config.yaml: |
            apiVersion: kapp.k14s.io/v1alpha1
            kind: Config
            rebaseRules:
            - paths:
              - [data]
              - [metadata, annotations, kubernetes.io/service-account.uid]
              type: copy
              sources: [existing, new]
              resourceMatchers:
              - kindNamespaceNameMatcher: {kind: Secret, namespace: pinniped-concierge, name: pinniped-concierge-impersonation-proxy}
  - kbld:
      paths:
      - "-"
  deploy:
  - kapp:
      rawOptions:
      - --wait-timeout=5m
      - --diff-changes=true
      - --diff-mask=true