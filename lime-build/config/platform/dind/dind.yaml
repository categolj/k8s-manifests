apiVersion: v1
kind: Namespace
metadata:
  name: docker
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: selfsigned-issuer
  namespace: docker
spec:
  selfSigned: { }
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: docker-dind-cert
  namespace: docker
spec:
  secretName: docker-dind-certs
  duration: 87600h
  renewBefore: 720h
  issuerRef:
    name: selfsigned-issuer
    kind: Issuer
  commonName: "docker-dind"
  dnsNames:
  - docker-dind.docker.svc.cluster.local
  - docker-dind.docker.svc
  - docker-dind.docker
  - docker-dind
  - localhost
  - 127.0.0.1
---
apiVersion: v1
kind: Service
metadata:
  name: docker-dind
  namespace: docker
spec:
  type: ClusterIP
  ports:
  - port: 2376
    targetPort: 2376
    protocol: TCP
  selector:
    app: docker-dind
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: docker-dind
  namespace: docker
spec:
  replicas: 1
  selector:
    matchLabels:
      app: docker-dind
  template:
    metadata:
      labels:
        app: docker-dind
    spec:
      containers:
      - name: docker-dind
        image: docker:dind
        securityContext:
          privileged: true
        env:
        - name: DOCKER_CERT_PATH
          value: /certs
        - name: DOCKER_TLS_VERIFY
          value: "1"
        command:
        - dockerd
        - --tlsverify
        - -H
        - tcp://0.0.0.0:2376
        ports:
        - containerPort: 2376
        volumeMounts:
        - name: certs-volume
          mountPath: /certs
      volumes:
      - name: certs-volume
        secret:
          secretName: docker-certs
---
apiVersion: secretgen.carvel.dev/v1alpha1
kind: SecretTemplate
metadata:
  name: docker-certs
  namespace: docker
spec:
  inputResources:
  - name: docker-dind-certs
    ref:
      apiVersion: v1
      kind: Secret
      name: docker-dind-certs
  template:
    data:
      ca.pem: $(.docker-dind-certs.data.ca\.crt)
      cert.pem: $(.docker-dind-certs.data.tls\.crt)
      key.pem: $(.docker-dind-certs.data.tls\.key)
---
apiVersion: secretgen.carvel.dev/v1alpha1
kind: SecretExport
metadata:
  name: docker-certs
  namespace: docker
spec:
  toNamespaces:
  - '*'