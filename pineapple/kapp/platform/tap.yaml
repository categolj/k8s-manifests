apiVersion: packaging.carvel.dev/v1alpha1
kind: PackageInstall
metadata:
  name: tap
  namespace: tap-install
  annotations:
    tkg.tanzu.vmware.com/tanzu-package-ClusterRole: tap-tap-install-cluster-role
    tkg.tanzu.vmware.com/tanzu-package-ClusterRoleBinding: tap-tap-install-cluster-rolebinding
    tkg.tanzu.vmware.com/tanzu-package-Secret: tap-tap-install-values
    tkg.tanzu.vmware.com/tanzu-package-ServiceAccount: tap-tap-install-sa
    kapp.k14s.io/change-group: "{name}"
    kapp.k14s.io/change-rule.create-order.0: "upsert after upserting tanzu-tap-repository"
    kapp.k14s.io/change-rule.create-order.1: "upsert after upserting tap-rbac"
    kapp.k14s.io/change-rule.create-order.2: "upsert after upserting tap-values"
    kapp.k14s.io/change-rule.create-order.3: "upsert after upserting tap-overlays"
spec:
  syncPeriod: 3h
  serviceAccountName: tap-tap-install-sa
  packageRef:
    refName: tap.tanzu.vmware.com
    versionSelection:
      constraints: 1.2.1
      prereleases: {}
  values:
  - secretRef:
      name: tap-tap-install-values
---
apiVersion: v1
kind: Secret
metadata:
  name: tap-tap-install-values
  namespace: tap-install
  annotations:
    kapp.k14s.io/change-group: "tap-install-values"
    kapp.k14s.io/change-rule.delete-order.0: "delete after deleting tap"
type: Opaque
stringData:
  tap-values.yml: |
    ---
    profile: run
    
    ceip_policy_disclosed: true
    
    contour:
      envoy:
        service:
          nodePorts:
            http: 31080
            https: 31443
    
    cnrs:
      domain_name: pineapple.maki.lol
      domain_template: "{{.Name}}-{{.Namespace}}.{{.Domain}}"
      default_tls_secret: tanzu-system-ingress/cnrs-default-tls
      provider: local
    
    supply_chain: basic

    package_overlays:
    - name: cnrs
      secrets:
      - name: cnrs-default-tls
      - name: cnrs-slim
      - name: cnrs-autocreate-cluster-domain-claims
    - name: tap-telemetry
      secrets:
      - name: tap-telemetry-remove

    excluded_packages:
    - connector.appliveview.tanzu.vmware.com
    - sso.apps.tanzu.vmware.com
    - image-policy-webhook.signing.apps.tanzu.vmware.com
    - policy.apps.tanzu.vmware.com
    - services-toolkit.tanzu.vmware.com
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    tkg.tanzu.vmware.com/tanzu-package: tap-tap-install
    kapp.k14s.io/change-group: "tap-rbac"
    kapp.k14s.io/change-rule.delete-order.0: "delete after deleting tap"
  name: tap-tap-install-cluster-role
rules:
- apiGroups:
  - '*'
  resources:
  - '*'
  verbs:
  - '*'
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    tkg.tanzu.vmware.com/tanzu-package: tap-tap-install
    kapp.k14s.io/change-group: "tap-rbac"
    kapp.k14s.io/change-rule.delete-order.0: "delete after deleting tap"
  name: tap-tap-install-cluster-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tap-tap-install-cluster-role
subjects:
- kind: ServiceAccount
  name: tap-tap-install-sa
  namespace: tap-install
---
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    tkg.tanzu.vmware.com/tanzu-package: tap-tap-install
    kapp.k14s.io/change-group: "tap-rbac"
    kapp.k14s.io/change-rule.delete-order.0: "delete after deleting tap"
  name: tap-tap-install-sa
  namespace: tap-install
---
apiVersion: v1
kind: Secret
metadata:
  name: cnrs-slim
  namespace: tap-install
  annotations:
    kapp.k14s.io/change-group: "tap-overlays"
    kapp.k14s.io/change-rule.delete-order.0: "delete after deleting tap"
type: Opaque
stringData:
  cnrs-slim.yml: |
    #@ load("@ytt:overlay", "overlay")
    #@overlay/match by=overlay.subset({"metadata":{"namespace":"knative-eventing"}}), expects="1+"
    #@overlay/remove
    ---
    #@overlay/match by=overlay.subset({"metadata":{"namespace":"knative-sources"}}), expects="1+"
    #@overlay/remove
    ---
    #@overlay/match by=overlay.subset({"metadata":{"namespace":"triggermesh"}}), expects="1+"
    #@overlay/remove
    ---
    #@overlay/match by=overlay.subset({"metadata":{"namespace":"vmware-sources"}}), expects="1+"
    #@overlay/remove
    ---
---
apiVersion: v1
kind: Secret
metadata:
  name: cnrs-default-tls
  namespace: tap-install
  annotations:
    kapp.k14s.io/change-group: "tap-overlays"
    kapp.k14s.io/change-rule.delete-order.0: "delete after deleting tap"
type: Opaque
stringData:
  cnrs-default-tls.yml: |
    #@ load("@ytt:data", "data")
    #@ load("@ytt:overlay", "overlay")
    #@ namespace = data.values.ingress.external.namespace
    ---
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: cnrs-default-tls
      namespace: #@ namespace
    spec:
      dnsNames:
      - #@ "*.{}".format(data.values.domain_name)
      - #@ "*.{}".format(data.values.domain_name.replace("apps.", ""))
      - #@ data.values.domain_name.replace("apps.", "")
      issuerRef:
        kind: ClusterIssuer
        name: letsencrypt-ik-am
      secretName: cnrs-default-tls
    ---
    apiVersion: projectcontour.io/v1
    kind: TLSCertificateDelegation
    metadata:
      name: contour-delegation
      namespace: #@ namespace
    spec:
      delegations:
      - secretName: cnrs-default-tls
        targetNamespaces:
        - "*"
    #@overlay/match by=overlay.subset({"metadata":{"name":"config-network"}, "kind": "ConfigMap"})
    ---
    data:
      #@overlay/match missing_ok=True
      default-external-scheme: https
---
apiVersion: v1
kind: Secret
metadata:
  name: cnrs-autocreate-cluster-domain-claims
  namespace: tap-install
  annotations:
    kapp.k14s.io/change-group: "tap-overlays"
    kapp.k14s.io/change-rule.delete-order.0: "delete after deleting tap"
type: Opaque
stringData:
  cnrs-autocreate-cluster-domain-claims.yml: |
    #@ load("@ytt:overlay", "overlay")
    #@overlay/match by=overlay.subset({"metadata":{"name":"config-network"}, "kind": "ConfigMap"})
    ---
    data:
      #@overlay/match missing_ok=True
      autocreate-cluster-domain-claims: "true"
---
apiVersion: v1
kind: Secret
metadata:
  name: tap-telemetry-remove
  namespace: tap-install
  annotations:
    kapp.k14s.io/change-group: "tap-overlays"
    kapp.k14s.io/change-rule.delete-order.0: "delete after deleting tap"
type: Opaque
stringData:
  tap-telemetry-remove.yml: |
    #@ load("@ytt:overlay", "overlay")
    #@overlay/match by=overlay.subset({"metadata":{"namespace":"tap-telemetry"}}), expects="1+"
    #@overlay/remove
    ---