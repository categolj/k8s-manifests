apiVersion: kappctrl.k14s.io/v1alpha1
kind: App
metadata:
  name: pinniped-supervisor
  namespace: kapp
  annotations:
    kapp.k14s.io/change-group: "{name}"
    kapp.k14s.io/change-rule.create-order.0: "upsert after upserting openldap"
    kapp.k14s.io/change-rule.delete-order.0: "delete before deleting openldap"
spec:
  serviceAccountName: kapp
  fetch:
  - http:
      url: https://github.com/vmware-tanzu/pinniped/releases/download/v0.15.0/install-pinniped-supervisor.yaml
  - git:
      url: https://github.com/categolj/k8s-manifests.git
      ref: origin/main
      subPath: pineapple/config/platform/pinniped
  syncPeriod: 6h
  template:
  - sops:
      pgp:
        privateKeysSecretRef:
          name: pgp-key
  - ytt:
      ignoreUnknownComments: true
      paths:
      - "0"
      - "1"
      inline:
        paths:
          pinniped-supervisor-service.yaml: |
            apiVersion: v1
            kind: Service
            metadata:
              name: pinniped-supervisor
              namespace: pinniped-supervisor
            spec:
              ports:
              - name: pinniped-supervisor
                port: 80
                protocol: TCP
                targetPort: 8080
              selector:
                app: pinniped-supervisor
          pinniped-supervisor-httpproxy.yaml: |
            apiVersion: cert-manager.io/v1
            kind: Certificate
            metadata:
              name: pinniped-supervisor
              namespace: pinniped-supervisor
            spec:
              dnsNames:
              - supervisor.pineapple.maki.lol
              issuerRef:
                kind: ClusterIssuer
                name: letsencrypt-maki-lol
              secretName: pinniped-supervisor-tls
            ---
            apiVersion: projectcontour.io/v1
            kind: HTTPProxy
            metadata:
              name: pinniped-supervisor
              namespace: pinniped-supervisor
            spec:
              virtualhost:
                fqdn: supervisor.pineapple.maki.lol
                tls:
                  secretName: pinniped-supervisor-tls
              routes:
              - services:
                - name: pinniped-supervisor
                  port: 80
          federateiondomain.yaml: |
            apiVersion: config.supervisor.pinniped.dev/v1alpha1
            kind: FederationDomain
            metadata:
              name: pinniped-supervisor-federation-domain
              namespace: pinniped-supervisor
            spec:
              issuer: https://supervisor.pineapple.maki.lol
              tls:
                secretName: pinniped-supervisor-tls
          fix-diff.yaml: |
            #@ load("@ytt:overlay", "overlay")
            #@overlay/match by=overlay.subset({"kind": "CustomResourceDefinition"}), expects="1+"
            ---
            #! https://github.com/vmware-tanzu/carvel-kapp/issues/395
            #@overlay/remove
            status:
  - kbld:
      paths:
      - "-"
  deploy:
  - kapp:
      rawOptions:
      - --wait-timeout=5m
      - --diff-changes=true
      - --diff-mask=true