#@ load("@ytt:overlay", "overlay")

#@overlay/match by=overlay.subset({"kind": "Service", "apiVersion": "serving.knative.dev/v1", "metadata": {"name": "blog-api"}})
---
spec:
  template:
    spec:
      containers:
      #@overlay/match by="name"
      - name: blog-api
        env:
        #@overlay/match by="name"
        - name: SPRING_R2DBC_URL
          value: "r2dbc:postgresql://${blog-db.instancename}.${blog-db.namespace}.svc.cluster.local:5432/${blog-db.dbname}?sslMode=VERIFY_FULL&sslRootCert=/blog-tls/ca.crt"
        volumeMounts:
        #@overlay/match by="name"
        - name: blog-db
          mountPath: /bindings/blog-db
        - name: blog-tls
          mountPath: /blog-tls
          readOnly: true
      volumes:
      #@overlay/match by="name"
      - name: blog-db
        secret:
          secretName: blog-db-db-secret
      #@overlay/append
      - name: blog-tls
        secret:
          secretName: blog-db-internal-ssl-secret
