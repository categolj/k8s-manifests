apiVersion: kappctrl.k14s.io/v1alpha1
kind: App
metadata:
  name: pinniped
  namespace: kapp
  annotations:
    kapp.k14s.io/change-group: "{name}"
spec:
  serviceAccountName: kapp
  fetch:
  - http:
      url: https://github.com/vmware-tanzu/pinniped/releases/download/v0.19.0/install-local-user-authenticator.yaml
  - http:
      url: https://github.com/vmware-tanzu/pinniped/releases/download/v0.19.0/install-pinniped-concierge-crds.yaml
  - http:
      url: https://github.com/vmware-tanzu/pinniped/releases/download/v0.19.0/install-pinniped-concierge-resources.yaml
  syncPeriod: 6h
  template:
  - ytt:
      ignoreUnknownComments: true
      paths:
      - .
      inline:
        paths:
          fix-diff.yaml: |
            #@ load("@ytt:overlay", "overlay")
            #@overlay/match by=overlay.subset({"kind": "CustomResourceDefinition"}), expects="1+"
            ---
            #! https://github.com/vmware-tanzu/carvel-kapp/issues/395
            #@overlay/remove
            status:
          kapp-config.yaml: |
            apiVersion: kapp.k14s.io/v1alpha1
            kind: Config
            rebaseRules:
            - paths:
              - [data]
              - [metadata, annotations, kubernetes.io/service-account.uid]
              type: copy
              sources: [existing, new]
              resourceMatchers:
              - kindNamespaceNameMatcher: {kind: Secret, namespace: pinniped-concierge, name: pinniped-concierge-impersonation-proxy}
          ingress.yaml: |
            #@ load("@ytt:overlay", "overlay")
            #@overlay/match by=overlay.subset({"kind": "Service", "metadata": {"name": "local-user-authenticator"}})
            ---
            metadata:
              #@overlay/match missing_ok=True
              annotations:
                #@overlay/match missing_ok=True
                projectcontour.io/upstream-protocol.tls: "8443"
            ---
            apiVersion: networking.k8s.io/v1
            kind: Ingress
            metadata:
              name: local-user-authenticator
              namespace: local-user-authenticator
              annotations:
                cert-manager.io/cluster-issuer: letsencrypt-maki-lol
            spec:
              tls:
              - secretName: local-user-authenticator-tls
                hosts:
                - local-user-authenticator.pineapple.maki.lol
              rules:
              - host: local-user-authenticator.pineapple.maki.lol
                http:
                  paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: local-user-authenticator
                        port:
                          number: 443
  - kbld:
      paths:
      - "-"
  deploy:
  - kapp:
      rawOptions:
      - --wait-timeout=5m
      - --diff-changes=true
      - --diff-mask=true