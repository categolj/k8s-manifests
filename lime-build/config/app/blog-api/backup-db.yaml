apiVersion: carto.run/v1alpha1
kind: Workload
metadata:
  labels:
    app.kubernetes.io/part-of: backup-db
    apps.tanzu.vmware.com/workload-type: cronjob
  annotations:
    kapp.k14s.io/disable-original: ""
  name: backup-db
  namespace: blog
spec:
  image: ghcr.io/categolj/psql-backup:latest
  params:
  - name: schedule
    value: 0 15 * * ?
  - name: command
    value:
    - /bin/bash
  - name: args
    value:
    - -c
    - |-
      set -eo pipefail
      mc config host add -C /tmp backup_host ${AWS_S3_HOST} ${AWS_ACCESS_KEY} ${AWS_ACCESS_SECRET}
      echo "Backup Started!"
      pg_dump -U ${DB_USER} -h ${DB_HOST} -p ${DB_PORT} ${DB_NAME} | mc pipe -C /tmp backup_host/${AWS_BUCKET_NAME}/$(date +"%Y")/$(date +"%m")/$(date +"%d")/backup-$(date +"%Y-%m-%d-%H-%M").sql
      echo "Backup Finished!"
  - name: testing_pipeline_matching_labels
    value:
      apps.tanzu.vmware.com/pipeline: test
      apps.tanzu.vmware.com/language: skip
  env:
  - name: AWS_S3_HOST
    valueFrom:
      secretKeyRef:
        name: backup-s3
        key: host
  - name: AWS_ACCESS_KEY
    valueFrom:
      secretKeyRef:
        name: backup-s3
        key: access_key
  - name: AWS_ACCESS_SECRET
    valueFrom:
      secretKeyRef:
        name: backup-s3
        key: access_secret
  - name: AWS_BUCKET_NAME
    value: backup-blog-db
  - name: DB_USER
    valueFrom:
      secretKeyRef:
        name: blog-db
        key: username
  - name: DB_HOST
    valueFrom:
      secretKeyRef:
        name: blog-db
        key: host
  - name: DB_PORT
    valueFrom:
      secretKeyRef:
        name: blog-db
        key: port
  - name: DB_NAME
    valueFrom:
      secretKeyRef:
        name: blog-db
        key: database
  - name: PGPASSWORD
    valueFrom:
      secretKeyRef:
        name: blog-db
        key: password