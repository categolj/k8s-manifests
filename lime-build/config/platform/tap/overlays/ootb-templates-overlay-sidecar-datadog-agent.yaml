apiVersion: v1
kind: Secret
metadata:
  name: ootb-templates-overlay-sidecar-datadog-agent
  namespace: tap-install
  annotations:
    kapp.k14s.io/change-group: "tap-overlays"
type: Opaque
stringData:
  overlay-sidecar-datadog-agent.yml: |
    #@ load("@ytt:overlay", "overlay")
    #@overlay/match by=overlay.subset({"kind":"ClusterConfigTemplate", "metadata": {"name": "convention-template"}})
    ---
    spec:
      #@overlay/replace via=lambda left, right: left + '        #@ if hasattr(data.values.params, "datadog") and hasattr(data.values.params.datadog, "api_key") and hasattr(data.values.params.datadog.api_key, "name") and hasattr(data.values.params.datadog.api_key, "key"):\n        - name: datadog-agent\n' + '\n'.join(['          {}'.format(x) for x in right.split('\n')])+ '\n        #@ end'
      ytt: |
                image: gcr.io/datadoghq/agent:7.42.0
                env:
                - name: DD_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: #@ data.values.params.datadog.api_key.name
                      key: #@ data.values.params.datadog.api_key.key
                - name: DD_SITE
                  value: us3.datadoghq.com
                - name: DD_LOG_LEVEL
                  value: INFO
                - name: DD_DOGSTATSD_PORT
                  value: "8125"
                - name: DD_DOGSTATSD_NON_LOCAL_TRAFFIC
                  value: "true"
                - name: DD_LOGS_ENABLED
                  value: "true"
                - name: DD_HEALTH_PORT
                  value: "5555"
                - name: DD_PROMETHEUS_SCRAPE_ENABLED
                  value: "true"
                - name: DD_PROMETHEUS_SCRAPE_VERSION
                  value: "2"
                ports:
                - containerPort: 8125
                  name: dogstatsdport
                  protocol: UDP
                livenessProbe:
                  failureThreshold: 6
                  httpGet:
                    path: /live
                    port: 5555
                  initialDelaySeconds: 15
                  periodSeconds: 15
                  timeoutSeconds: 5    
                readinessProbe:
                  failureThreshold: 6
                  httpGet:
                    path: /ready
                    port: 5555
                  initialDelaySeconds: 15
                  periodSeconds: 15
                  timeoutSeconds: 5